<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Carsten Urbach" />


<title>Exponentiation modulo n</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Exponentiation modulo n</h1>
<h4 class="author">Carsten Urbach</h4>



<p>Note that for this we roughly follow the paper by Vedral, Barenco and Ekert <span class="citation">(1996)</span>. However, we use the addition by qft instead <span class="citation">(Draper 2000)</span> of the procedure using Toffoli gates.</p>
<div id="multiplication-modulo-2n" class="section level2">
<h2>Multiplication modulo <span class="math inline">\(2^n\)</span></h2>
<p>For multiplying a state <span class="math inline">\(|j\rangle\)</span> with a constant <span class="math inline">\(a\)</span> we can follow the scheme to multiply two numbers in binary representation. As an example, multiply <span class="math inline">\(5\)</span> with <span class="math inline">\(3\)</span>. <span class="math inline">\(5\)</span> has binary representation <span class="math inline">\(0101\)</span> and <span class="math inline">\(3\)</span> has <span class="math inline">\(0011\)</span>. So, the procedure for <span class="math inline">\(5\cdot 3\)</span> is</p>
<pre><code>  00011 * 1 (1*3)
+ 00110 * 0 (0*6)
+ 01100 * 1 (1*12)
+ 11000 * 0 (0*24)
= 01111 (15)</code></pre>
<p>Now, if we have a controlled add operation, we can use the qubits of the first register (in this case representing <span class="math inline">\(5\)</span>) as control bits and the other register as the constant to add. The single terms in the sum can be efficiently pre-computed classically as follows</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>summands &lt;-<span class="st"> </span><span class="cf">function</span>(x, n, N) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  b &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">intToBits</span>(x))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  ret &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>N)) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    s &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>N)) {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>      s &lt;-<span class="st"> </span>s<span class="op">+</span><span class="kw">as.integer</span>(b[j])<span class="op">*</span><span class="dv">2</span><span class="op">^</span>(i<span class="op">+</span>j<span class="dv">-2</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    }</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    ret[i] &lt;-<span class="st"> </span>s <span class="op">%%</span><span class="st"> </span>n</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>  }</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>  <span class="kw">return</span>(ret)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>}</span></code></pre></div>
<p>Example</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="dv">3</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="kw">summands</span>(<span class="dv">3</span>, <span class="dv">2</span><span class="op">^</span><span class="dv">3</span>, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>[1] 3 6 4</code></pre>
<p>Now we need a controlled add operation. Here we can build on our add operation using the qft for which we need a controlled phase shift operation first</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>cRtheta &lt;-<span class="st"> </span><span class="cf">function</span>(bits, <span class="dt">theta=</span><span class="fl">0.</span>) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>  <span class="kw">cqgate</span>(<span class="dt">bits=</span>bits, <span class="dt">gate=</span>methods<span class="op">::</span><span class="kw">new</span>(<span class="st">&quot;sqgate&quot;</span>, <span class="dt">bit=</span><span class="kw">as.integer</span>(bits[<span class="dv">2</span>]),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>                                      <span class="dt">M=</span><span class="kw">array</span>(<span class="kw">as.complex</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">exp</span>(1i<span class="op">*</span>theta))),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>                                              <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>)), <span class="dt">type=</span><span class="st">&quot;Rt&quot;</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>cadd &lt;-<span class="st"> </span><span class="cf">function</span>(c, bits, x, y) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>  n &lt;-<span class="st"> </span><span class="kw">length</span>(bits)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cqft</span>(<span class="dt">c=</span>c, <span class="dt">x=</span>x, <span class="dt">bits=</span>bits)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    z  &lt;-<span class="st"> </span><span class="kw">cRtheta</span>(<span class="dt">bits=</span><span class="kw">c</span>(c, bits[i]), <span class="dt">theta =</span> <span class="dv">2</span><span class="op">*</span>pi<span class="op">*</span>y<span class="op">/</span><span class="dv">2</span><span class="op">^</span>(n<span class="op">-</span>i<span class="op">+</span><span class="dv">1</span>)) <span class="op">*</span><span class="st"> </span>z</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>  }</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cqft</span>(<span class="dt">c=</span>c, <span class="dt">x=</span>z, <span class="dt">inverse=</span><span class="ot">TRUE</span>, <span class="dt">bits=</span>bits)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">invisible</span>(z))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>}</span></code></pre></div>
<p>Let’s check whether it works as expected (keep in mind that the register is 3 qubit wide plus 1 control qubit, so addition is modulo <span class="math inline">\(2^3=8\)</span>):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>basis &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">4-1</span>))) basis[i<span class="op">+</span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;|&quot;</span>, i <span class="op">%/%</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;&gt;|&quot;</span>, i <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;&gt;&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">H</span>(<span class="dv">1</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">4</span>, <span class="dt">basis=</span>basis)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>c &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>bits &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>x, <span class="dt">y=</span><span class="dv">5</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|0&gt; 
 + ( 0.7071068 )    * |5&gt;|1&gt; </code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">2</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|0&gt; 
 + ( 0.7071068 )    * |7&gt;|1&gt; </code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">8</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|0&gt; 
 + ( 0.7071068 )    * |7&gt;|1&gt; </code></pre>
<p>Equipped with this functionality, we can finally perform a binary multiplication. Note that we need two registers, the first one to store the initial value and the second one to store the final result of the multiplication</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>mult &lt;-<span class="st"> </span><span class="cf">function</span>(reg1, reg2, x, y, <span class="dt">swap=</span><span class="ot">TRUE</span>) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(reg1) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(reg2))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>  n &lt;-<span class="st"> </span><span class="kw">length</span>(reg2)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>  s &lt;-<span class="st"> </span><span class="kw">summands</span>(y, <span class="dv">2</span><span class="op">^</span>n, n)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>reg1[i], <span class="dt">bits=</span>reg2, <span class="dt">x=</span>x, <span class="dt">y=</span>s[i])</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>  }</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>  <span class="cf">if</span>(swap) {</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>      x &lt;-<span class="st"> </span><span class="kw">SWAP</span>(<span class="kw">c</span>(reg1[i], reg2[i])) <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>    }</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>  }</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">invisible</span>(x))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>}</span></code></pre></div>
<p>With this we can perform a <em>reversible</em> multiplication, which is why we we introduced the SWAP operations at the end. They interchange the two registers. The result is the following</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>basis &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">3-1</span>))) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">3-1</span>))) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>    basis[i<span class="op">*</span><span class="dv">2</span><span class="op">^</span><span class="dv">3</span><span class="op">+</span>j <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;|&quot;</span>, i, <span class="st">&quot;&gt;|&quot;</span>, j, <span class="st">&quot;&gt;&quot;</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>  }</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>}</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">X</span>(<span class="dv">2</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">6</span>, <span class="dt">basis=</span>basis)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 1 )    * |0&gt;|2&gt; </code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>reg1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>reg2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span><span class="op">:</span><span class="dv">6</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">mult</span>(reg1, reg2, <span class="dt">x=</span>x, <span class="dt">y=</span><span class="dv">3</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">X</span>(<span class="dv">5</span>) <span class="op">*</span><span class="st"> </span>z</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 1 )    * |0&gt;|6&gt; </code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">mult</span>(reg1, reg2, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">3</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 1 )    * |6&gt;|2&gt; </code></pre>
<p>Let’s be a bit more precise here for the multiplication of, say <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> in two registers, both <span class="math inline">\(n\)</span> qubits wide. Starting with both registers in state <span class="math inline">\(|0\rangle\)</span>, we can first bring the result register to state <span class="math inline">\(|1\rangle\)</span> using a NOT operation, i.e. <span class="math inline">\(|0\rangle|1\rangle\)</span>. Now, we multiply by <span class="math inline">\(a\)</span>, which leaves us with state <span class="math display">\[
|a \mod 2^n \rangle|1\rangle
\]</span> which we can apply the NOT gate again to reset the result register to state <span class="math inline">\(|0\rangle\)</span> and then we swap the two registers to arrive at <span class="math display">\[
|0\rangle|a \mod 2^n\rangle\,.
\]</span> Now we multiply by <span class="math inline">\(b\)</span> getting us to state <span class="math display">\[
|a\times b \mod 2^n\rangle|a \mod 2^n\rangle\,.
\]</span> Multiply the result register with the inverse of <span class="math inline">\(a \mod n\)</span> and apply the NOT gate getting us to <span class="math display">\[
|0\rangle|a\times b \mod 2^n\rangle\,.
\]</span> The inverse modulo <span class="math inline">\(2^n\)</span> can be computed efficiently in a classical way by the extended Euclidean algorithm</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a>eEa &lt;-<span class="st"> </span><span class="cf">function</span>(a, b) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>  <span class="cf">if</span>(a <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">return</span>(<span class="kw">c</span>(b, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>  res &lt;-<span class="st"> </span><span class="kw">eEa</span>(b <span class="op">%%</span><span class="st"> </span>a, a)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">c</span>(res[<span class="dv">1</span>], res[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>(b <span class="op">%/%</span><span class="st"> </span>a) <span class="op">*</span><span class="st"> </span>res[<span class="dv">2</span>], res[<span class="dv">2</span>]))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>}</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>moduloinverse &lt;-<span class="st"> </span><span class="cf">function</span>(a, n) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>  res &lt;-<span class="st"> </span><span class="kw">eEa</span>(<span class="dt">a=</span>a, <span class="dt">b=</span>n)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>  <span class="cf">if</span>(res[<span class="dv">1</span>] <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>) <span class="kw">stop</span>(<span class="st">&quot;inverse does not exist!&quot;</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>  <span class="kw">return</span>(res[<span class="dv">2</span>] <span class="op">%%</span><span class="st"> </span>n)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>}</span></code></pre></div>
<p>If <span class="math inline">\(a\)</span> and <span class="math inline">\(2^n\)</span> are not coprime, the inverse does not exist. However, for the application we have in mind this is not an issue.</p>
</div>
<div id="working-modulo-n" class="section level2">
<h2>Working modulo <span class="math inline">\(N\)</span></h2>
<p>So far we have assumed that we work modulo <span class="math inline">\(2^n\)</span>, where <span class="math inline">\(n\)</span> was dictated by the number of qubits. However, this is not the realistic case. We have to write an adder modulo <span class="math inline">\(N&lt;2^n\)</span>, i.e. <span class="math inline">\(|x\rangle\to|x + y\mod N\rangle\)</span>. We can implement this by subtracting <span class="math inline">\(N &lt; 2^n\)</span> whenever needed. We will follow the convention that if <span class="math inline">\(x\geq N\)</span> the operation will be <span class="math inline">\(|x\rangle\to|x\rangle\)</span>. Moreover, we will assume <span class="math inline">\(x,y\geq 0\)</span>.</p>
<p>To find out, when this subtraction is needed, is a bit tricky. We want to add <span class="math inline">\(y\)</span> to <span class="math inline">\(x\)</span>. To decide beforehand, whether or not we have to subtract <span class="math inline">\(N\)</span>, we have to check whether <span class="math inline">\(x &lt; N-y\)</span>. If not, we have to subtract <span class="math inline">\(N\)</span>. If we subtract <span class="math inline">\(N-y\)</span> from this state <span class="math inline">\(|x\rangle\)</span>, the most significant qubit indicates whether there occurred an overflow. Using a CNOT gate we can store this info in one ancilla bit <span class="math inline">\(c_1\)</span>. Then we add <span class="math inline">\(N-y\)</span> again to retain the original state. Such an operation can be implemented as follows in a controlled manner (control bit <span class="math inline">\(c\)</span>, <code>bits</code> the bits in state <span class="math inline">\(|x\rangle\)</span> where x is stored, <span class="math inline">\(a\)</span> an ancilla bit and <span class="math inline">\(y\)</span> the value to compare with.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a>cis.less &lt;-<span class="st"> </span><span class="cf">function</span>(c, bits, x, c1, a, y) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>  <span class="co">## add ancilla bit as most significant bit to bits</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>  b &lt;-<span class="st"> </span><span class="kw">c</span>(bits, a)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>  n &lt;-<span class="st"> </span><span class="kw">length</span>(b)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>  <span class="co">## cadd works modulo 2^n</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>b, <span class="dt">x=</span>x, <span class="dt">y=</span><span class="dv">2</span><span class="op">^</span>n<span class="op">-</span>y)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>  <span class="co">## &#39;copy&#39; overflow bit</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">CNOT</span>(<span class="kw">c</span>(a, c1)) <span class="op">*</span><span class="st"> </span>z</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a>  <span class="co">## add back, resetting ancilla a to |0&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>b, <span class="dt">x=</span>z, <span class="dt">y=</span>y)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a>  <span class="kw">return</span>(z)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a>}</span></code></pre></div>
<p>This routine will set the qubit <span class="math inline">\(|c_1\rangle\)</span> to 1 if <span class="math inline">\(|x_\mathrm{bits}\rangle\)</span> is smaller than <span class="math inline">\(y\)</span> and leave it at zero otherwise. It uses <span class="math inline">\(|a\rangle\)</span> as ancilla bit and <span class="math inline">\(|c\rangle\)</span> as control bit. Here an example</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>basis &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">6-1</span>))) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>  basis[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] &lt;-</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a><span class="st">    </span><span class="kw">paste0</span>(<span class="st">&quot;|&quot;</span>, i <span class="op">%/%</span><span class="st"> </span><span class="dv">8</span> ,<span class="st">&quot;&gt;|a=&quot;</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>    (i <span class="op">%/%</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;&gt;|c1=&quot;</span>, (i<span class="op">%/%</span><span class="dv">2</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>    <span class="st">&quot;&gt;|c=&quot;</span>, i<span class="op">%%</span><span class="dv">2</span>, <span class="st">&quot;&gt;&quot;</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a>}</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">H</span>(<span class="dv">1</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">6</span>, <span class="dt">basis=</span>basis)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span><span class="dv">1</span>, <span class="dt">bits=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>), <span class="dt">x=</span>x, <span class="dt">y=</span><span class="dv">5</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|a=0&gt;|c1=0&gt;|c=0&gt; 
 + ( 0.7071068 )    * |5&gt;|a=0&gt;|c1=0&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="co">## 5 &lt; 7 -&gt; c1 = 1</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>v &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span><span class="dv">1</span>, <span class="dt">bits=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>), <span class="dt">x=</span>z, <span class="dt">c1=</span><span class="dv">2</span>, <span class="dt">a=</span><span class="dv">3</span>, <span class="dt">y=</span><span class="dv">7</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>v</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|a=0&gt;|c1=0&gt;|c=0&gt; 
 + ( 0.7071068 )    * |5&gt;|a=0&gt;|c1=1&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="co">## 5 &gt; 3 -&gt; c1 = 0</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>w &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span><span class="dv">1</span>, <span class="dt">bits=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>), <span class="dt">x=</span>z, <span class="dt">c1=</span><span class="dv">2</span>, <span class="dt">a=</span><span class="dv">3</span>, <span class="dt">y=</span><span class="dv">3</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>w</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|a=0&gt;|c1=0&gt;|c=0&gt; 
 + ( 0.7071068 )    * |5&gt;|a=0&gt;|c1=0&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="co">## 5 &lt; 9 -&gt; c1 = 1</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a>w &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span><span class="dv">1</span>, <span class="dt">bits=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>), <span class="dt">x=</span>z, <span class="dt">c1=</span><span class="dv">2</span>, <span class="dt">a=</span><span class="dv">3</span>, <span class="dt">y=</span><span class="dv">9</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a>w</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |0&gt;|a=0&gt;|c1=0&gt;|c=0&gt; 
 + ( 0.7071068 )    * |5&gt;|a=0&gt;|c1=1&gt;|c=1&gt; </code></pre>
<p>Now, recall that if <span class="math inline">\(x\geq N\)</span> we want the operation to leave the state unchanged. So, we need two <code>cis.less</code> operations, one to check whether <span class="math inline">\(x &lt; N\)</span>, which we store in ancilla qubit <span class="math inline">\(c_1\)</span> and another one to check whether <span class="math inline">\(x &lt; N-y\)</span> stored in <span class="math inline">\(c_2\)</span>. Note that the combination <span class="math inline">\(c_1=0, c_2=1\)</span> is not possible. The implementation looks as follows:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a>caddmodN &lt;-<span class="st"> </span><span class="cf">function</span>(c, bits, c1, c2, a, x, y, N) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(a) <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">length</span>(c1) <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;&amp;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a><span class="st">            </span><span class="kw">length</span>(c2) <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;&amp;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a><span class="st">            </span><span class="kw">length</span>(<span class="kw">unique</span>(<span class="kw">c</span>(c1, c2, a))) <span class="op">==</span><span class="st"> </span><span class="dv">3</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>  y &lt;-<span class="st"> </span>y <span class="op">%%</span><span class="st"> </span>N</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>  <span class="co">## set c1=1 if x &lt; N</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>x, <span class="dt">c1=</span>c1, <span class="dt">a=</span>a, <span class="dt">y=</span>N)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a>  <span class="co">## set c2=1 if x &lt; N - y</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">c1=</span>c2, <span class="dt">a=</span>a, <span class="dt">y=</span>N<span class="op">-</span>y)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a>  </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a>  <span class="co">## if c1 and not c2, x = x + y - N</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">X</span>(c2) <span class="op">*</span>( <span class="kw">CCNOT</span>(<span class="kw">c</span>(c1, c2, a)) <span class="op">*</span><span class="st"> </span>(<span class="kw">X</span>(c2) <span class="op">*</span><span class="st"> </span>z))</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>a, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">y=</span>y <span class="op">-</span><span class="st"> </span>N)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">X</span>(c2) <span class="op">*</span><span class="st"> </span>(<span class="kw">CCNOT</span>(<span class="kw">c</span>(c1, c2, a)) <span class="op">*</span><span class="st"> </span>(<span class="kw">X</span>(c2) <span class="op">*</span><span class="st"> </span>z))</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true"></a>  </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true"></a>  <span class="co">## if c1 and c2 add x = x + y</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">CCNOT</span>(<span class="kw">c</span>(c1, c2, a)) <span class="op">*</span><span class="st"> </span>z</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cadd</span>(<span class="dt">c=</span>a, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">y=</span>y)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">CCNOT</span>(<span class="kw">c</span>(c1, c2, a)) <span class="op">*</span><span class="st"> </span>z</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true"></a>  </span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true"></a>  <span class="co">## reset c1,2</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">c1=</span>c2, <span class="dt">a=</span>a, <span class="dt">y=</span>y)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">CNOT</span>(<span class="kw">c</span>(c1, c2)) <span class="op">*</span><span class="st"> </span>z</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true"></a>  z &lt;-<span class="st"> </span><span class="kw">cis.less</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">x=</span>z, <span class="dt">c1=</span>c1, <span class="dt">a=</span>a, <span class="dt">y=</span>N)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">invisible</span>(z))</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true"></a>}</span></code></pre></div>
<p>For the reset part: in the first step we flip <span class="math inline">\(c_2\)</span> if <span class="math inline">\(x + y \mod N &lt; y\)</span>. This can only be true if <span class="math inline">\(x&gt;N-y\)</span>. If <span class="math inline">\(c_2\)</span> was 1, it’s zero now and the other way around. The next CNOT gate flips <span class="math inline">\(c_2\)</span> to <span class="math inline">\(|0\rangle\)</span>. The last step resets <span class="math inline">\(c_1\)</span> to <span class="math inline">\(|0\rangle\)</span>.</p>
<p>You can also see from the routine above that, if <span class="math inline">\(x\geq N\)</span> then <code>caddmodN</code> leaves the state unchanged.</p>
<p>Example</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a>basis &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">7-1</span>))) {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a>  basis[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] &lt;-</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a><span class="st">    </span><span class="kw">paste0</span>(<span class="st">&quot;|&quot;</span>, i <span class="op">%/%</span><span class="st"> </span><span class="dv">16</span> , <span class="st">&quot;&gt;|a=&quot;</span>, (i <span class="op">%/%</span><span class="st"> </span><span class="dv">8</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a>           <span class="st">&quot;&gt;|c2=&quot;</span>, (i <span class="op">%/%</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a>           <span class="st">&quot;&gt;|c1=&quot;</span>, (i<span class="op">%/%</span><span class="dv">2</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;&gt;|c=&quot;</span>, i<span class="op">%%</span><span class="dv">2</span>, <span class="st">&quot;&gt;&quot;</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true"></a>}</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">X</span>(<span class="dv">1</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">7</span>, <span class="dt">basis=</span>basis)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 1 )    * |0&gt;|a=0&gt;|c2=0&gt;|c1=0&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a>bits &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a>c &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a>c1 &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a>c2 &lt;-<span class="st"> </span><span class="dv">3</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a>a &lt;-<span class="st"> </span><span class="dv">4</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a>N &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">caddmodN</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">c1=</span>c1, <span class="dt">c2=</span>c2, <span class="dt">a=</span>a, <span class="dt">x=</span>x, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">N=</span>N) <span class="co"># 0 + 3 mod 5</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 1 )    * |3&gt;|a=0&gt;|c2=0&gt;|c1=0&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">caddmodN</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">c1=</span>c1, <span class="dt">c2=</span>c2, <span class="dt">a=</span>a, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">1</span>, <span class="dt">N=</span>N) <span class="co"># 3 + 1 mod 5</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 1 )    * |4&gt;|a=0&gt;|c2=0&gt;|c1=0&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">caddmodN</span>(<span class="dt">c=</span>c, <span class="dt">bits=</span>bits, <span class="dt">c1=</span>c1, <span class="dt">c2=</span>c2, <span class="dt">a=</span>a, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">6</span>, <span class="dt">N=</span>N) <span class="co"># 4 + 6 mod 5</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 1 )    * |0&gt;|a=0&gt;|c2=0&gt;|c1=0&gt;|c=1&gt; </code></pre>
</div>
<div id="controlled-multiplier-modulo-n" class="section level1">
<h1>Controlled Multiplier modulo <span class="math inline">\(N\)</span></h1>
<p>Now, like the <code>mult</code> function above a version performing <span class="math inline">\(|x\rangle\to|x+y\mod N\rangle\)</span>. Here we also include the un-computation of the second register. <code>reg1</code> is the result register.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a>cmultmodN &lt;-<span class="st"> </span><span class="cf">function</span>(c, reg1, reg2, ancillas, x, y, N) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(reg1) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(reg2))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true"></a>  <span class="co">## need 4 ancilla registers</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(ancillas) <span class="op">==</span><span class="st"> </span><span class="dv">4</span> <span class="op">&amp;&amp;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true"></a><span class="st">            </span><span class="kw">length</span>(<span class="kw">unique</span>(ancillas)) <span class="op">==</span><span class="st"> </span><span class="dv">4</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true"></a>  n &lt;-<span class="st"> </span><span class="kw">length</span>(reg2)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true"></a>  <span class="co">## precompute terms in the sum</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true"></a>  s &lt;-<span class="st"> </span><span class="kw">summands</span>(y, N, n)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true"></a>  <span class="co">## start with |x&gt;|0&gt;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">CCNOT</span>(<span class="kw">c</span>(c, reg1[i], ancillas[<span class="dv">4</span>])) <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">caddmodN</span>(<span class="dt">c=</span>ancillas[<span class="dv">4</span>], <span class="dt">bits=</span>reg2,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true"></a>                  <span class="dt">c1=</span>ancillas[<span class="dv">1</span>], <span class="dt">c2=</span>ancillas[<span class="dv">2</span>],</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true"></a>                  <span class="dt">a=</span>ancillas[<span class="dv">3</span>],</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true"></a>                  <span class="dt">x=</span>x, <span class="dt">y=</span>s[i], <span class="dt">N=</span>N)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">CCNOT</span>(<span class="kw">c</span>(c, reg1[i], ancillas[<span class="dv">4</span>])) <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true"></a>  }</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true"></a>  <span class="co">## now |x&gt;|xy mod N&gt;</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">CSWAP</span>(<span class="kw">c</span>(c, reg1[i], reg2[i])) <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true"></a>  }</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true"></a>  <span class="co">## now |xy mod N&gt;|x&gt;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true"></a>  <span class="co">## -y_inv mod N</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true"></a>  yinv &lt;-<span class="st"> </span>N <span class="op">-</span><span class="st"> </span><span class="kw">moduloinverse</span>(<span class="dt">a=</span>y, <span class="dt">n=</span>N)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true"></a>  s &lt;-<span class="st"> </span><span class="kw">summands</span>(yinv, N, n)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">CCNOT</span>(<span class="kw">c</span>(c, reg1[i], ancillas[<span class="dv">4</span>])) <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">caddmodN</span>(<span class="dt">c=</span>ancillas[<span class="dv">4</span>], <span class="dt">bits=</span>reg2,</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true"></a>                  <span class="dt">c1=</span>ancillas[<span class="dv">1</span>], <span class="dt">c2=</span>ancillas[<span class="dv">2</span>],</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true"></a>                  <span class="dt">a=</span>ancillas[<span class="dv">3</span>],</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true"></a>                  <span class="dt">x=</span>x, <span class="dt">y=</span>s[i], <span class="dt">N=</span>N)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">CCNOT</span>(<span class="kw">c</span>(c, reg1[i], ancillas[<span class="dv">4</span>])) <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true"></a>  }</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true"></a>  <span class="co">## finally |xy mod N&gt;|0&gt;</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">invisible</span>(x))</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true"></a>}</span></code></pre></div>
<p>For the un-computation of the second register, we start in the state (only the two registers <code>reg1</code> and <code>reg2</code>) <span class="math display">\[
|x\cdot y \mod N\rangle|x\rangle\,.
\]</span> Now we determine <span class="math inline">\(yy_\mathrm{inv} = 1\mod N\)</span> the modular inverse of <span class="math inline">\(y\)</span> (which is only possible, if <span class="math inline">\(y\)</span> and <span class="math inline">\(N\)</span> are co-prime). If we set <span class="math inline">\(y&#39; = xy\mod N\)</span> it follows <span class="math inline">\(y_\mathrm{inv}y&#39; = y_\mathrm{inv}yx\mod N=x\mod N\)</span>. Thus, <span class="math inline">\(x=y_\mathrm{inv}y&#39;\mod N\)</span>. So, if we perform the following trafo <span class="math display">\[
|y&#39;\rangle|x\rangle\to|y&#39;\rangle|x-y_\mathrm{inv}y&#39;\mod N\rangle = |y&#39;\rangle|0\rangle\,.
\]</span> we obtain <span class="math inline">\(|x\cdot y \mod N\rangle|0\rangle\)</span>.</p>
<p>Example with two 3 qubit registers, which is starting to become slow, because in total we need 11 qubits</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a>basis &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span><span class="op">:</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">11-1</span>))) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a>  basis[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] &lt;-</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a><span class="st">    </span><span class="kw">paste0</span>(<span class="st">&quot;|reg1=&quot;</span>, i <span class="op">%/%</span><span class="st"> </span>(<span class="dv">32</span><span class="op">*</span><span class="dv">2</span><span class="op">^</span><span class="dv">3</span>) , <span class="st">&quot;&gt;|reg2=&quot;</span>, (i <span class="op">%/%</span><span class="st"> </span><span class="dv">32</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span><span class="dv">3</span> ,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a>           <span class="st">&quot;|anc=&quot;</span>, (i <span class="op">%/%</span><span class="st"> </span><span class="dv">16</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a>           (i <span class="op">%/%</span><span class="st"> </span><span class="dv">8</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>, (i <span class="op">%/%</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true"></a>           (i<span class="op">%/%</span><span class="dv">2</span>) <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;&gt;|c=&quot;</span>, i<span class="op">%%</span><span class="dv">2</span>, <span class="st">&quot;&gt;&quot;</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true"></a>}</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">CNOT</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)) <span class="op">*</span><span class="st"> </span>(<span class="kw">H</span>(<span class="dv">1</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">11</span>, <span class="dt">basis=</span>basis))</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=2&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a>c &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a>ancillas &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true"></a>reg2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true"></a>reg1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">9</span><span class="op">:</span><span class="dv">11</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true"></a>N &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cmultmodN</span>(<span class="dt">c=</span>c, <span class="dt">reg1=</span>reg1, <span class="dt">reg2=</span>reg2,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true"></a>               <span class="dt">ancillas=</span>ancillas, <span class="dt">x=</span>x, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">N=</span>N)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=1&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cmultmodN</span>(<span class="dt">c=</span>c, <span class="dt">reg1=</span>reg1, <span class="dt">reg2=</span>reg2,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a>               <span class="dt">ancillas=</span>ancillas, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">N=</span>N)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=3&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cmultmodN</span>(<span class="dt">c=</span>c, <span class="dt">reg1=</span>reg1, <span class="dt">reg2=</span>reg2,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a>               <span class="dt">ancillas=</span>ancillas, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">N=</span>N)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=4&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a>z &lt;-<span class="st"> </span><span class="kw">cmultmodN</span>(<span class="dt">c=</span>c, <span class="dt">reg1=</span>reg1, <span class="dt">reg2=</span>reg2,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a>               <span class="dt">ancillas=</span>ancillas, <span class="dt">x=</span>z, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">N=</span>N)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true"></a>z</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=2&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<p>This seems to work up to this point.</p>
<div id="exponentiation-modulo-n" class="section level2">
<h2>Exponentiation modulo <span class="math inline">\(N\)</span></h2>
<p>For the order finding algorithm, we have to implement the operation <span class="math inline">\(f_{a,N}(x) = a^x y \mod N\)</span>, where we set <span class="math inline">\(y=1\)</span> in the following. All this is stored in a <span class="math inline">\(n\)</span> qubit register with <span class="math inline">\(2^n &gt; N\)</span>.</p>
<p>So, the following function implements the unitary operation naively <span class="math display">\[
|x\rangle\ \to\ |xy^a \mod N\rangle
\]</span></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a>cexpomodN &lt;-<span class="st"> </span><span class="cf">function</span>(c, reg1, reg2, ancillas, x, y, a, N) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(reg1) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(reg2))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true"></a>  <span class="co">## need 4 ancilla registers</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(ancillas) <span class="op">==</span><span class="st"> </span><span class="dv">4</span> <span class="op">&amp;&amp;</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true"></a><span class="st">            </span><span class="kw">length</span>(<span class="kw">unique</span>(ancillas)) <span class="op">==</span><span class="st"> </span><span class="dv">4</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>a)) {</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true"></a>    x &lt;-<span class="st"> </span><span class="kw">cmultmodN</span>(<span class="dt">c=</span>c, <span class="dt">reg1=</span>reg1, <span class="dt">reg2=</span>reg2,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true"></a>                   <span class="dt">ancillas=</span>ancillas, <span class="dt">x=</span>x, <span class="dt">y=</span>y, <span class="dt">N=</span>N)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true"></a>  }</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">invisible</span>(x))</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true"></a>}</span></code></pre></div>
<p>Example, performing the same example operation as above, i.e. starting with <span class="math inline">\(x=2\)</span> and multiplying it with <span class="math inline">\(y^a\mod N\)</span>, with <span class="math inline">\(a=4\)</span>, <span class="math inline">\(y=3\)</span> and <span class="math inline">\(N=5\)</span>.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">CNOT</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)) <span class="op">*</span><span class="st"> </span>(<span class="kw">H</span>(<span class="dv">1</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">11</span>, <span class="dt">basis=</span>basis))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=2&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">cexpomodN</span>(c, reg1, reg2, ancillas, x, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">a=</span><span class="dv">4</span>, N)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=2&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<p>The result should equal 2.</p>
<p>Using the binary representation of <span class="math inline">\(x\)</span>, we can write <span class="math display">\[
y^a\ =\ y^{2^0 a_0} \cdot y^{2^1 a_1} \cdot \ldots y^{2^{m-1}a_{m-1}}
\]</span> if <span class="math inline">\(x\)</span> is stored with <span class="math inline">\(m\)</span> bits. So, alternatively, if we start with the result register in state <span class="math inline">\(|1\rangle\)</span> we have to multiply successivly <span class="math inline">\(m\)</span>-times by <span class="math inline">\(a^{2^i} \mod n\)</span> depending on the value of the qubit <span class="math inline">\(|x_i\rangle\)</span>. This task can be also achieved with the controlled multiplier developed above. However, we need one more register to store <span class="math inline">\(a\)</span>. Let’s cheat here a bit and use a classical <code>if</code>-statement. For large <span class="math inline">\(a\)</span> this implementation is of course much faster, but the factors <span class="math inline">\(y^{2^i}\)</span> become very large very quickly. That’s why we apply the modulo</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true"></a>cexpomodN2 &lt;-<span class="st"> </span><span class="cf">function</span>(c, reg1, reg2, ancillas, x, y, a, N) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(reg1) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(reg2))</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true"></a>  <span class="co">## need 4 ancilla registers</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true"></a>  <span class="kw">stopifnot</span>(<span class="kw">length</span>(ancillas) <span class="op">==</span><span class="st"> </span><span class="dv">4</span> <span class="op">&amp;&amp;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true"></a><span class="st">            </span><span class="kw">length</span>(<span class="kw">unique</span>(ancillas)) <span class="op">==</span><span class="st"> </span><span class="dv">4</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true"></a>  ab &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">intToBits</span>(a))</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true"></a>  n &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">which</span>(ab <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true"></a>  y2 &lt;-<span class="st"> </span>y <span class="op">%%</span><span class="st"> </span>N</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span>n)) {</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true"></a>    <span class="cf">if</span>(ab[i] <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true"></a>      x &lt;-<span class="st"> </span><span class="kw">cmultmodN</span>(<span class="dt">c=</span>c, <span class="dt">reg1=</span>reg1, <span class="dt">reg2=</span>reg2,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true"></a>                     <span class="dt">ancillas=</span>ancillas, <span class="dt">x=</span>x, <span class="dt">y=</span>y2, <span class="dt">N=</span>N)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true"></a>    }</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true"></a>    y2 &lt;-<span class="st"> </span>((y2<span class="op">%%</span>N) <span class="op">*</span><span class="st"> </span>(y2<span class="op">%%</span>N)) <span class="op">%%</span><span class="st"> </span>N <span class="co"># y2=y^(2^i) mod N</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true"></a>  }</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true"></a>  <span class="kw">return</span>(<span class="kw">invisible</span>(x))</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true"></a>}</span></code></pre></div>
<p>Example</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">CNOT</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)) <span class="op">*</span><span class="st"> </span>(<span class="kw">H</span>(<span class="dv">1</span>)<span class="op">*</span><span class="kw">qstate</span>(<span class="dv">11</span>, <span class="dt">basis=</span>basis))</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=2&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a>x &lt;-<span class="st"> </span><span class="kw">cexpomodN2</span>(c, reg1, reg2, ancillas, x, <span class="dt">y=</span><span class="dv">3</span>, <span class="dt">a=</span><span class="dv">4</span>, N)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true"></a>x</span></code></pre></div>
<pre><code>   ( 0.7071068 )    * |reg1=0&gt;|reg2=0|anc=0000&gt;|c=0&gt; 
 + ( 0.7071068 )    * |reg1=2&gt;|reg2=0|anc=0000&gt;|c=1&gt; </code></pre>
</div>
</div>
<div id="bibliography" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references hanging-indent">
<div id="ref-draper2000addition">
<p>Draper, Thomas G. 2000. “Addition on a Quantum Computer.” <em>arXiv Preprint Quant-Ph/0008033</em>.</p>
</div>
<div id="ref-Vedral_1996">
<p>Vedral, Vlatko, Adriano Barenco, and Artur Ekert. 1996. “Quantum Networks for Elementary Arithmetic Operations.” <em>Physical Review A</em> 54 (1): 147–53. <a href="https://doi.org/10.1103/physreva.54.147">https://doi.org/10.1103/physreva.54.147</a>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
